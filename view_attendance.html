{% extends "base.html" %}

{% block title %}View Attendance - Smart Attendance{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">View Attendance</h1>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Filter Attendance</h5>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Subject</label>
                <select class="form-select" name="subject_id">
                    <option value="">All Subjects</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.subject_id }}" 
                            {% if filters.subject_id == subject.subject_id|string %}selected{% endif %}>
                        {{ subject.subject_code }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Section</label>
                <select class="form-select" name="section">
                    <option value="">All Sections</option>
                    <option value="A" {% if filters.section == 'A' %}selected{% endif %}>A</option>
                    <option value="B" {% if filters.section == 'B' %}selected{% endif %}>B</option>
                    <option value="C" {% if filters.section == 'C' %}selected{% endif %}>C</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" name="date" value="{{ filters.date }}">
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    Filter
                </button>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <a href="/view_attendance" class="btn btn-outline-secondary w-100">
                    Reset
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Attendance Sessions -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            Attendance Sessions 
            {% if filters.subject_id or filters.section or filters.date %}
            <span class="badge bg-primary ms-2">Filtered</span>
            {% endif %}
        </h5>
    </div>
    <div class="card-body">
        {% if sessions %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Date</th>
                        <th>Subject</th>
                        <th>Section</th>
                        <th>Total</th>
                        <th>Present</th>
                        <th>Absent</th>
                        <th>Percentage</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in sessions %}
                    <tr>
                        <td>
                            <strong>{{ session.session_date }}</strong>
                        </td>
                        <td>{{ session.subject_code }}</td>
                        <td>
                            <span class="badge bg-primary">{{ session.section }}</span>
                        </td>
                        <td>{{ session.total_students }}</td>
                        <td>
                            <span class="badge bg-success">{{ session.present_count }}</span>
                        </td>
                        <td>
                            <span class="badge bg-danger">{{ session.total_students - session.present_count }}</span>
                        </td>
                        <td>
                            <span class="badge 
                                {% if session.attendance_percentage >= 75 %}bg-success
                                {% elif session.attendance_percentage >= 50 %}bg-warning
                                {% else %}bg-danger{% endif %}">
                                {{ session.attendance_percentage }}%
                            </span>
                        </td>
                        <td>
                            <a href="/view_attendance?session_id={{ session.session_id }}{% if filters.subject_id %}&subject_id={{ filters.subject_id }}{% endif %}{% if filters.section %}&section={{ filters.section }}{% endif %}{% if filters.date %}&date={{ filters.date }}{% endif %}" 
                               class="btn btn-sm btn-outline-primary">
                                View Details
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Attendance Sessions</h4>
            <p class="text-muted">
                {% if filters.subject_id or filters.section or filters.date %}
                Try changing filters
                {% else %}
                No attendance taken yet
                {% endif %}
            </p>
            <a href="/take_attendance" class="btn btn-primary">
                Take Attendance
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Detailed Attendance Records -->
{% if attendance_data %}
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            Detailed Attendance - Session {{ filters.session_id }}
            <span class="badge bg-info ms-2">Click buttons to correct attendance</span>
        </h5>
        <div>
            <span class="badge bg-success me-2" id="present-count">Present: {{ attendance_data|selectattr('status', 'equalto', 'present')|list|length }}</span>
            <span class="badge bg-danger" id="absent-count">Absent: {{ attendance_data|selectattr('status', 'equalto', 'absent')|list|length }}</span>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Enrollment</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Confidence</th>
                        <th>Time</th>
                        <th>Manual Correction</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in attendance_data %}
                    <tr id="row-{{ record.record_id }}">
                        <td><strong>{{ record.enrollment_no }}</strong></td>
                        <td>{{ record.name }}</td>
                        <td>
                            <span class="badge bg-{% if record.status == 'present' %}success{% else %}danger{% endif %}" 
                                  id="status-{{ record.record_id }}">
                                {{ record.status|title }}
                            </span>
                        </td>
                        <td>
                            {% if record.confidence_score %}
                            <span class="badge bg-info">{{ record.confidence_score }}%</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ record.recognition_time.strftime('%H:%M') if record.recognition_time else '' }}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success btn-sm {% if record.status == 'present' %}active{% endif %}" 
                                        onclick="updateAttendance('{{ record.record_id }}', 'present', '{{ record.enrollment_no }}')">
                                    <i class="fas fa-check"></i> Present
                                </button>
                                <button class="btn btn-outline-danger btn-sm {% if record.status == 'absent' %}active{% endif %}"
                                        onclick="updateAttendance('{{ record.record_id }}', 'absent', '{{ record.enrollment_no }}')">
                                    <i class="fas fa-times"></i> Absent
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-3">
            <a href="/view_attendance{% if filters.subject_id %}?subject_id={{ filters.subject_id }}{% if filters.section %}&section={{ filters.section }}{% endif %}{% if filters.date %}&date={{ filters.date }}{% endif %}{% endif %}" 
               class="btn btn-outline-secondary">
                Back to Sessions
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function updateAttendance(recordId, newStatus, enrollmentNo) {
    if (!confirm('Change ' + enrollmentNo + ' to ' + newStatus + '?')) {
        return;
    }
    
    // Show loading state
    var row = document.getElementById('row-' + recordId);
    var originalContent = row.innerHTML;
    row.innerHTML = '<td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Updating...</td>';
    
    // Send update request
    fetch('/update_attendance_record', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'record_id=' + recordId + '&status=' + newStatus
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        // RESTORE THE ROW FIRST
        row.innerHTML = originalContent;
        
        if (data.success) {
            // Update the status badge
            var statusBadge = document.getElementById('status-' + recordId);
            if (statusBadge) {
                statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                if (newStatus === 'present') {
                    statusBadge.className = 'badge bg-success';
                } else {
                    statusBadge.className = 'badge bg-danger';
                }
            }
            
            // Update button active states
            var presentBtn = row.querySelector('.btn-outline-success');
            var absentBtn = row.querySelector('.btn-outline-danger');
            
            if (presentBtn && absentBtn) {
                presentBtn.classList.remove('active');
                absentBtn.classList.remove('active');
                
                if (newStatus === 'present') {
                    presentBtn.classList.add('active');
                } else {
                    absentBtn.classList.add('active');
                }
            }
            
            // Update counts
            updateAttendanceCounts();
            
            // Show success message
            showNotification('✅ Attendance updated for ' + enrollmentNo, 'success');
        } else {
            throw new Error(data.error || 'Update failed');
        }
    })
    .catch(function(error) {
        // Restore original content on error
        row.innerHTML = originalContent;
        showNotification('❌ Error: ' + error.message, 'error');
        console.error('Update error:', error);
    });
}

function updateAttendanceCounts() {
    var presentCount = 0;
    var absentCount = 0;
    
    // Count all status badges
    var badges = document.querySelectorAll('[id^="status-"]');
    for (var i = 0; i < badges.length; i++) {
        var badge = badges[i];
        if (badge.classList.contains('bg-success')) {
            presentCount++;
        } else if (badge.classList.contains('bg-danger')) {
            absentCount++;
        }
    }
    
    var presentCountElement = document.getElementById('present-count');
    var absentCountElement = document.getElementById('absent-count');
    
    if (presentCountElement) {
        presentCountElement.textContent = 'Present: ' + presentCount;
    }
    if (absentCountElement) {
        absentCountElement.textContent = 'Absent: ' + absentCount;
    }
}

function showNotification(message, type) {
    // Create notification element
    var notification = document.createElement('div');
    notification.className = 'alert alert-' + (type === 'error' ? 'danger' : 'success') + ' alert-dismissible fade show';
    notification.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    
    // Add to page
    var container = document.querySelector('.container-fluid');
    if (container) {
        container.insertBefore(notification, container.firstChild);
    }
    
    // Auto remove after 3 seconds
    setTimeout(function() {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Initialize counts on page load
document.addEventListener('DOMContentLoaded', function() {
    updateAttendanceCounts();
});
</script>
{% endblock %}